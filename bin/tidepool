#!/bin/bash -eu
shopt -s extglob

DIR=$(cd $(dirname $(dirname ${0})); pwd)

usage() {
  cat <<EOF
=======================================================
USAGE: tidepool command [service] [...additional args]

  ### Kubernetes Server Commands ###

  server-start                    Start the Kind server and private registry containers
  server-stop                     Stop the Kind server and private registry containers

  server-destroy                  Shut down and completely remove the local Kubernetes server and
                                  all services


  ### Tidepool Services Commands ###

  start                           Provision and start the Tidepool services
  stop                            Stop and remove the Tidepool services
  restart [service]               Restart the specified service
  logs [service]                  Tail logs for the specified service

  exec service [...cmds]          Run shell commands in the currently running service
                                  container
                                    example:
                                      tidepool exec blip sh
                                      (to enter a shell inside the blip container)
                                    example:
                                      tidepool exec blip "ls -lR /app/node_modules/ | grep ^l | uniq"
                                      (to list all symlinked npm packages, such as after yarn linking)

  yarn [service] [...cmds]        Run yarn commands against the specified Node.js-based service.
                                  [service] must be one of:
                                    blip, @tidepool/viz, tideline, tidepool-platform-client,
                                    export, gatekeeper, highwater, jellyfish, message-api, seagull
                                  NOTE: tideline, @tidepool/viz, and tidepool-platform-client
                                  are optional Tilt-provided mounts within the blip service
                                    example: tidepool yarn @tidepool/viz stories
                                    example: tidepool yarn tidepool-platform-client test

  port-forward [service] [port]   Forward a port to a running service container
  verify-account-email [email]    Complete the email address verification step for a created account

  restart-proxy                   Restart the external gateway proxy
                                  Useful if the exposed "blip" port stops responding on host machine


  ### Other Commands ###

  doctor                          Check to see if all dependancies are up-to-date, and recommended
                                  environment variables are set
EOF
}

server_start() {
  docker start tidepool-kind-control-plane
  docker start ctlptl-registry
}

server_stop() {
  docker stop tidepool-kind-control-plane
  docker stop ctlptl-registry
}

restart() { (for P in ${@}; do kubectl scale deployment --replicas=0 ${P} && kubectl scale deployment --replicas=1 ${P}; done) }

run_exec() { args="${@:2}" && (kubectl exec -ti svc/${1} -c ${1} -- /bin/sh -c "${args}") }

check_version() {
  pkg=${1}
  version_cmd=${2}
  min=${3}
  if [ $([[ $($pkg $version_cmd) =~ [0-9\.]+ ]] && printf "${min}\n${BASH_REMATCH}" | sort -V | head -n1) = "$min" ]; then
      echo "✔ ${pkg} is up to date"
  else
      echo "✘ ${pkg} is out of date. Please install version >= ${min}"
  fi
}

check_environment() {
  if [[ ! -z ${!1} ]]; then
    echo "✔ \$${1} is set"
  else
    echo "✘ \$${1} is not set. See \"Environment Setup\" in README"
  fi
}

doctor() {
  set +u
  echo "Checking dependancy versions..."
  check_version helm 'version --short' 3.0.2
  check_version tilt 'version' 0.16.1
  check_version docker '-v' 19.0.0
  check_version docker-compose '-v' 1.25.0
  check_version kubectl 'version --client --short' 1.18.2
  echo
  echo "Checking environment config..."
  check_environment KUBECONFIG
  check_environment TIDEPOOL_DOCKER_MONGO_VOLUME
}

run_yarn() {
  NODE_SERVICES='@(blip|export|gatekeeper|highwater|jellyfish|message-api|seagull)'
  BLIP_MOUNTED_NODE_SERVICES='@(tideline|tidepool-platform-client|@tidepool/viz)'

  if [[ ${BLIP_MOUNTED_NODE_SERVICES} =~ ${1} ]]; then
    run_exec blip "cd ./packageMounts/${1} && yarn ${@:2}"
  elif [[ ${NODE_SERVICES} =~ ${1} ]]; then
    run_exec ${1} "yarn ${@:2}"
  else
    printf "The yarn command can only be run on Node.js services\n\n"
  fi
}

set_tilt_env() {
  case "$1" in
    --trap-shutdown) trap 'SHUTTING_DOWN=1 tilt down' EXIT;;
    --shutdown) export SHUTTING_DOWN=1;;
  esac
}

wait_for_kubernetes_ready() {
  until curl -s --fail http://127.0.0.1:10080/kubernetes-ready; do
    sleep 1;
  done
}

set_kubeconfig() {
  wait_for_kubernetes_ready
  curl http://127.0.0.1:10080/config | sed "s|172.30.99.1|127.0.0.1|g" > ${KUBECONFIG}
}

destroy() {
  read -p "Are you sure you want to destroy the local tidepool server? [N|y] " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
    docker rm -fv tidepool-kind-control-plane
    docker rm -fv ctlptl-registry
    rm -r ${DIR}/local/charts
  else
    echo "Destroy command aborted"
  fi
}

case ${1-help} in
  server-start) server_start;;
  server-stop) server_stop;;
  server-destroy) destroy;;
  start) (cd ${DIR} && set_tilt_env --trap-shutdown && tilt up -dv --port=0 --legacy ${2-});;
  stop) (cd ${DIR} && set_tilt_env --shutdown && tilt down);;
  restart) shift 1 && restart ${@};;
  logs) (cd ${DIR} && kubectl logs svc/${2} --tail=100 -c ${2} -f);;
  exec) run_exec ${2} ${@:3};;
  yarn) run_yarn ${2} "${@:3}";;
  port-forward) (cd ${DIR} && kubectl port-forward svc/${2} ${3});;
  verify-account-email) mongo --eval "db.users.update({username: \"${@:2}\"},{\$set:{\"authenticated\":true}});" user;;
  restart-proxy) restart gateway-proxy;;
  doctor) doctor;;
  *) usage;;
esac
